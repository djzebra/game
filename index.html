<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #FFFFFF;
        }
        #unity-canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #FFFFFF;
        }
    </style>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">
</head>
<body>
    <div id="loading-text">Loading</div>
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <script src="pako.js"></script>
    <script>
        const unityFiles = {};

        async function fetchAndStoreFile(url, name) {
            const db = await new Promise((resolve, reject) => {
                const request = indexedDB.open('gameFilesDB', 1);
                request.onupgradeneeded = () => { const db = request.result; db.createObjectStore('files', { keyPath: 'name' }); };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            const response = await fetch(url);
            const buffer = await response.arrayBuffer();
            const contentType = response.headers.get('Content-Type');
            const data = contentType === 'application/gzip' ? pako.inflate(new Uint8Array(buffer)) : new Uint8Array(buffer);
            const transaction = db.transaction('files', 'readwrite');
            const store = transaction.objectStore('files');
            store.put({ name, file: new Blob([data]) });
            return new Promise(resolve => transaction.oncomplete = resolve);
        }

        async function getFilesToUnity() {
            await new Promise(resolve => { const request = indexedDB.deleteDatabase('gameFilesDB'); request.onsuccess = resolve; });

            const files = [
                { url: 'https://game-sepia-ten.vercel.app/DJ-Raw.data.gz', name: 'DJ-Raw.data' },
                { url: 'https://game-sepia-ten.vercel.app/DJ-Raw.framework.js.gz', name: 'DJ-Raw.framework.js' },
                { url: 'https://game-sepia-ten.vercel.app/DJ-Raw.wasm.gz', name: 'DJ-Raw.wasm' },
                { url: 'https://game-sepia-ten.vercel.app/DJ-Raw.loader.js', name: 'DJ-Raw.loader.js' }
            ];
            await Promise.all(files.map(f => fetchAndStoreFile(f.url, f.name)));

            const db = await new Promise((resolve, reject) => {
                const request = indexedDB.open('gameFilesDB', 1);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            const transaction = db.transaction('files', 'readonly');
            const store = transaction.objectStore('files');
            const filesList = await new Promise(resolve => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });

            filesList.forEach(file => {
                const url = URL.createObjectURL(file.file);
                unityFiles[file.name] = url;
            });
        }

        getFilesToUnity().then(() => {
            const loaderScript = document.createElement('script');
            loaderScript.src = unityFiles['DJ-Raw.loader.js'];
            document.head.appendChild(loaderScript);

            loaderScript.onload = () => {
                console.log('DJ-Raw.loader.js loaded and executed.');

                function resizeCanvas() {
                    const canvas = document.querySelector("#unity-canvas");
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }

                createUnityInstance(document.querySelector("#unity-canvas"), {
                    dataUrl: unityFiles["DJ-Raw.data"],
                    frameworkUrl: unityFiles["DJ-Raw.framework.js"],
                    codeUrl: unityFiles["DJ-Raw.wasm"],
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "77",
                    productName: "DJ",
                    productVersion: "1.0.0",
                    matchWebGLToCanvasSize: false,
                    devicePixelRatio: window.devicePixelRatio
                }).then(() => {
                    document.getElementById("loading-text").style.display = "none";
                    resizeCanvas();
                    window.addEventListener('resize', resizeCanvas);
                }).catch((error) => {
                    console.error('Error initializing Unity WebGL:', error);
                });
            };

            loaderScript.onerror = () => {
                console.error('Failed to load DJ-Raw.loader.js');
            };
        });
    </script>
</body>
</html>
